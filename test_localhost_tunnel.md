# 本机隧道功能测试

## 功能概述
这个功能允许用户在NPS Web界面中选择"本机"作为客户端，直接代理NPS服务器本机的端口，无需额外的客户端程序。

## 测试步骤

### 1. 启动NPS服务器
```bash
# 在Windows上启动NPS服务器
./nps.exe start
```

### 2. 访问Web管理界面
- 访问 http://localhost:8080 (根据配置文件设定)
- 登录管理界面

### 3. 创建本机隧道
1. 进入"TCP隧道"页面
2. 点击"新增"按钮
3. 选择客户端ID：选择"本机 (NPS服务器)"
4. 服务端端口：输入要映射的外部端口，例如 `9999`
5. 目标地址：输入要代理的本机端口，例如 `127.0.0.1:555`（如果本机555端口有服务的话）
6. 点击"新增"

### 4. 验证功能
1. 在本机555端口启动一个测试服务（如果没有的话）：
   ```bash
   # 使用Python创建简单HTTP服务器
   python -m http.server 555
   ```
   
2. 通过NPS外部端口访问：
   ```bash
   # 测试连接
   curl http://localhost:9999
   ```
   
3. 应该能够访问到本机555端口的服务

### 5. 预期结果
- 能够成功创建本机隧道
- 客户端ID显示为"本机 (NPS服务器)"
- LocalProxy自动设置为true
- 通过外部端口9999能够访问到本机555端口的服务
- 无需运行任何客户端程序

## 核心实现要点

### 1. 特殊客户端ID
- 定义了常量 `LOCALHOST_CLIENT_ID = -1` 表示本机客户端

### 2. 虚拟客户端创建
- 当选择本机客户端时，`getClientOrCreateLocalhost()` 会创建虚拟客户端
- 虚拟客户端不存储到文件，不在客户端列表中显示

### 3. 自动LocalProxy设置
- 当客户端ID为 `-1` 时，自动设置 `LocalProxy = true`
- Bridge.SendLinkInfo 检测到 LocalProxy 为 true 时，直接连接本地端口

### 4. 代理逻辑
```go
// bridge/bridge.go SendLinkInfo方法中
if link.LocalProxy {
    target, err = net.Dial("tcp", link.Host)
    return
}
```

## 支持的隧道类型
- TCP隧道：√
- UDP隧道：√  
- HTTP代理：√
- SOCKS5代理：√
- 私密代理：√
- P2P连接：√

## 注意事项
1. 本机隧道直接在NPS服务器本地建立连接，性能最佳
2. 不需要客户端程序，减少了网络开销
3. 适用于代理服务器本机服务的场景
4. 支持多语言显示（中文/英文）

## 故障排除
1. 如果无法创建隧道，检查目标端口是否可用
2. 如果连接失败，检查目标服务是否在运行
3. 查看NPS日志获取详细错误信息